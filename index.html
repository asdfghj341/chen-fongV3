<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>隔音墊施工計算 - 團隊協作版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        // 您的 Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyAOL5kA2POWbfGLULAwERTxzetCqVo_Xx8",
            authDomain: "chen-fongv1.firebaseapp.com",
            projectId: "chen-fongv1",
            storageBucket: "chen-fongv1.firebasestorage.app",
            messagingSenderId: "251834902996",
            appId: "1:251834902996:web:b9b7fd80823c1a216b8e41"
        };

        if (!firebase.apps.length) {
            window.firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            window.firebaseApp = firebase.app();
        }
        window.db = firebase.firestore();
        window.auth = firebase.auth();
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        #error-display { display: none; padding: 20px; background: #fee2e2; color: #991b1b; border: 1px solid #f87171; margin: 20px; border-radius: 8px; }
        .login-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="error-display"></div>
    <div id="root"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const display = document.getElementById('error-display');
            display.style.display = 'block';
            display.innerHTML = `<strong>發生錯誤：</strong><br>${message}<br><small>${source}:${lineno}</small>`;
        };

        function startApp() {
            const container = document.getElementById('root');
            if (container && window.ReactDOM && window.ReactDOM.createRoot && window.SoundproofingCalculator) {
                ReactDOM.createRoot(container).render(React.createElement(window.SoundproofingCalculator));
            }
        }
        
        window.onload = startApp;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // --- 輔助函數 ---
        const parseNum = (val) => {
            if (!val) return 0;
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        };
        const formatCurrency = (num) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(num);
        const formatNumber = (num) => new Intl.NumberFormat('zh-TW').format(num);
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const getUserName = (user) => user.displayName || user.email.split('@')[0];

        // --- ICONS ---
        const IconBase = ({ d, color="currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d={d} />
            </svg>
        );
        const Trash2 = () => <IconBase d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />;
        const Calculator = () => <IconBase d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z M6 10h12 M6 14h12 M6 18h12" />; 
        const DollarSign = () => <IconBase d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />;
        const Package = () => <IconBase d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16zM3.27 6.96L12 12.01l8.73-5.05M12 22.08V12" />;
        const Activity = () => <IconBase d="M22 12h-4l-3 9L9 3l-3 9H2" />;
        const TrendingUp = () => <IconBase d="M23 6l-9.5 9.5-5-5L1 18" />;
        const Plus = () => <IconBase d="M12 5v14M5 12h14" />;
        const FolderOpen = () => <IconBase d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />;
        const LogOut = () => <IconBase d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />;
        const Users = () => <IconBase d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />;
        const GoogleIcon = () => (
            <svg className="w-5 h-5" viewBox="0 0 24 24">
                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
        );

        // --- 資料處理 ---
        const sanitizeProjects = (projects) => {
            if (!Array.isArray(projects)) return [];
            return projects.map(p => ({
                ...p,
                paymentRequests: (p.paymentRequests || []).map(i => ({...i, id: i.id || generateId(), value: i.value || ''})),
                deductions: (p.deductions || []).map(i => ({...i, id: i.id || generateId(), value: i.value || ''})),
                deliveries: (p.deliveries || []).map(i => ({...i, id: i.id || generateId(), value: i.value || ''})),
                subPayments: (p.subPayments || []).map(i => ({...i, id: i.id || generateId(), value: i.value || ''})),
                contractQty: p.contractQty?.toString() || '',
                unitPrice: p.unitPrice?.toString() || '',
                unusedInventory: p.unusedInventory?.toString() || '',
                projectedArea: p.projectedArea?.toString() || '',
                wallArea: p.wallArea?.toString() || '',
                glueBuckets: p.glueBuckets?.toString() || '',
                tapeWideRolls: p.tapeWideRolls?.toString() || '',
                tapeNarrowRolls: p.tapeNarrowRolls?.toString() || '',
                shippingCost: p.shippingCost?.toString() || '',
            }));
        };

        const createInitialState = (projectName = '新專案', uid = null, userName = '') => ({
            projectName: projectName, 
            uid: uid, 
            lastUpdatedBy: userName, // 新增：記錄創建者/修改者
            contractQty: '',
            unitPrice: '',
            paymentRequests: [{ id: generateId(), value: '' }],
            deductions: [{ id: generateId(), name: '清潔費', value: '' }, { id: generateId(), name: '保留款', value: '' }],
            deliveries: [{ id: generateId(), date: '', value: '' }],
            unusedInventory: '',
            projectedArea: '',
            wallArea: '',
            subPayments: [{ id: generateId(), value: '' }],
            glueBuckets: '',
            tapeWideRolls: '',
            tapeNarrowRolls: '',
            shippingCost: '',
            lastUpdated: Date.now(),
        });

        // --- 元件 (保持不變) ---
        const Card = ({ title, icon: Icon, children }) => (
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex items-center gap-2">
                    {Icon && <Icon />}
                    <h2 className="font-bold text-lg text-slate-800">{title}</h2>
                </div>
                <div className="p-6">{children}</div>
            </div>
        );

        const SectionHeader = ({ title }) => (
            <h3 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-3 mt-2">{title}</h3>
        );

        const SimpleInput = ({ label, value, onChange, type = "number", placeholder = "", suffix = "" }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-slate-700 mb-1">{label}</label>
                <div className="relative rounded-md shadow-sm">
                    <input
                        type={type}
                        value={value}
                        onChange={(e) => onChange(e.target.value)}
                        className="block w-full rounded-md border-slate-300 pl-3 pr-12 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm border"
                        placeholder={placeholder}
                        step="any"
                    />
                    {suffix && (
                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <span className="text-slate-500 sm:text-sm">{suffix}</span>
                        </div>
                    )}
                </div>
            </div>
        );

        const DynamicListItem = ({ item, index, labelPrefix, valueField = "value", dateField, unitPrice, showPriceCalc, updateRow, onRemove }) => {
            const calculatedAmount = showPriceCalc ? parseNum(item[valueField]) * parseNum(unitPrice) : 0;
            
            return (
                <div className="flex flex-col gap-1 pb-3 border-b border-slate-100 last:border-0">
                    <div className="flex gap-2 items-end">
                        {dateField && (
                            <div className="w-1/3">
                                <label className="block text-xs text-slate-500 mb-1">日期</label>
                                <input
                                    type="date"
                                    value={item[dateField]}
                                    onChange={(e) => updateRow(item.id, dateField, e.target.value)}
                                    className="block w-full rounded-md border-slate-300 py-2 px-2 text-sm border focus:ring-blue-500"
                                />
                            </div>
                        )}
                        <div className="flex-1">
                            <label className="block text-xs text-slate-500 mb-1">{labelPrefix} {index + 1}</label>
                            <input
                                type="number"
                                value={item[valueField]}
                                onChange={(e) => updateRow(item.id, valueField, e.target.value)}
                                className="block w-full rounded-md border-slate-300 py-2 px-3 text-sm border focus:ring-blue-500"
                                placeholder="輸入數量"
                            />
                        </div>
                        <button onClick={() => onRemove(item.id)} className="mb-[2px] p-2 text-red-500 hover:bg-red-50 rounded-md transition-colors">
                            <Trash2 />
                        </button>
                    </div>
                    {showPriceCalc && (
                        <div className="text-xs text-slate-500 text-right px-1">
                            = <span className="font-medium text-blue-600">{formatCurrency(calculatedAmount)}</span>
                        </div>
                    )}
                </div>
            );
        };

        const DynamicList = ({ items, onAdd, onRemove, onUpdate, ...props }) => (
            <div className="space-y-3 mb-4">
                {items.map((item, index) => (
                    <DynamicListItem key={item.id} item={item} index={index} updateRow={onUpdate} onRemove={onRemove} {...props} />
                ))}
                <button onClick={onAdd} className="flex items-center gap-1 text-sm text-blue-600 font-medium hover:text-blue-700 mt-2">
                    <Plus /> 新增項目
                </button>
            </div>
        );

        const DeductionItem = ({ item, updateRow, onRemove }) => { 
            return (
                <div className="flex gap-2 items-end mb-3">
                    <div className="flex-1">
                        <label className="block text-xs text-slate-500 mb-1">項目名稱</label>
                        <input
                            type="text"
                            value={item.name}
                            onChange={(e) => updateRow(item.id, 'name', e.target.value)}
                            className="block w-full rounded-md border-slate-300 py-2 px-3 text-sm border focus:ring-blue-500"
                            placeholder="例如: 清潔費"
                        />
                    </div>
                    <div className="w-1/3">
                        <label className="block text-xs text-slate-500 mb-1">金額</label>
                        <input
                            type="number"
                            value={item.value}
                            onChange={(e) => updateRow(item.id, 'value', e.target.value)}
                            className="block w-full rounded-md border-slate-300 py-2 px-3 text-sm border focus:ring-blue-500"
                        />
                    </div>
                    <button onClick={() => onRemove(item.id)} className="mb-[2px] p-2 text-red-500 hover:bg-red-50 rounded-md">
                        <Trash2 />
                    </button>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen login-bg flex flex-col items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                    <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Calculator />
                    </div>
                    <h1 className="text-2xl font-bold text-slate-800 mb-2">隔音墊施工計算</h1>
                    <p className="text-slate-500 mb-2">團隊協作版</p>
                    <p className="text-xs text-slate-400 mb-8">登入後可查看並編輯所有專案</p>
                    
                    <button 
                        onClick={onLogin}
                        className="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 text-slate-700 font-semibold py-3 px-4 rounded-lg hover:bg-slate-50 transition-colors shadow-sm"
                    >
                        <GoogleIcon />
                        使用 Google 帳號登入
                    </button>
                </div>
            </div>
        );

        window.SoundproofingCalculator = function SoundproofingCalculator() {
            // User State
            const [user, setUser] = useState(null);
            const [loadingAuth, setLoadingAuth] = useState(true);

            // Project State
            const [projects, setProjects] = useState([]);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [tempProjectName, setTempProjectName] = useState(''); 
            
            // 監聽登入狀態
            useEffect(() => {
                const unsubscribe = window.auth.onAuthStateChanged(currentUser => {
                    setUser(currentUser);
                    setLoadingAuth(false);
                });
                return () => unsubscribe();
            }, []);

            // 登入 - 修改處：改用 Redirect 模式
            const handleLogin = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                window.auth.signInWithRedirect(provider);
            };

            // 登出
            const handleLogout = () => {
                window.auth.signOut();
                setProjects([]); 
            };

            // 新增專案 (共用模式)
            const handleCreateProject = useCallback((name = `新專案 ${projects.length + 1}`) => {
                if (!user) return;
                const newProjectData = createInitialState(name, user.uid, getUserName(user)); // 記錄創建者
                window.db.collection('projects').add(newProjectData)
                    .then(docRef => {
                        setCurrentProjectId(docRef.id);
                    })
                    .catch(error => console.error("新增專案失敗:", error));
            }, [projects.length, user]);

            const handleDeleteProject = (id) => {
                if (!confirm("確定要刪除此專案嗎？刪除後無法復原，其他人也將看不到此專案。")) return;
                window.db.collection('projects').doc(id).delete()
                    .catch(error => console.error("刪除專案失敗:", error));
            };

            // 通用更新函數 (會記錄 lastUpdatedBy)
            const updateToFirestore = useCallback((docId, data) => {
                if (!user) return;
                window.db.collection('projects').doc(docId).update({ 
                    ...data, 
                    lastUpdated: Date.now(),
                    lastUpdatedBy: getUserName(user) // 自動記錄是誰改的
                }).catch(error => console.error(`更新失敗:`, error));
            }, [user]);

            const updateSingleFieldToFirestore = useCallback((field, value) => {
                if (!currentProjectId) return;
                updateToFirestore(currentProjectId, { [field]: value });
            }, [currentProjectId, updateToFirestore]);

            // 監聽 Firestore (移除 uid 過濾，實現共享)
            useEffect(() => {
                if (!user) return;

                // 修改：移除 .where('uid', '==', user.uid)，實現所有用戶資料共享
                const unsubscribe = window.db.collection('projects')
                    .orderBy('lastUpdated', 'desc')
                    .onSnapshot(snapshot => {
                        const loadedProjects = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        const sanitized = sanitizeProjects(loadedProjects);
                        setProjects(sanitized);

                        if (sanitized.length > 0) {
                            if (!currentProjectId || !sanitized.find(p => p.id === currentProjectId)) {
                                setCurrentProjectId(sanitized[0].id);
                            }
                        } else {
                            if (loadedProjects.length === 0) {
                                // 只有當整個資料庫都空的時候才自動新增，避免每個新進來的人都自動新增
                                // 這裡可以留空，或是給個提示
                            }
                        }
                    }, error => {
                        console.error("Firestore 監聽失敗:", error);
                        if (error.code === 'failed-precondition') {
                            console.log("需要建立索引");
                        }
                    });

                return () => unsubscribe(); 
            }, [currentProjectId, user]); 

            const currentProject = useMemo(() => {
                return projects.find(p => p.id === currentProjectId) || createInitialState('載入中...');
            }, [projects, currentProjectId]);

            useEffect(() => {
                setTempProjectName(currentProject.projectName);
            }, [currentProject.projectName]); 

            useEffect(() => {
                if (!currentProjectId || tempProjectName === currentProject.projectName) return;
                const handler = setTimeout(() => {
                    updateSingleFieldToFirestore('projectName', tempProjectName);
                }, 500);
                return () => clearTimeout(handler);
            }, [tempProjectName, currentProject.projectName, currentProjectId, updateSingleFieldToFirestore]);


            const updateProjectField = updateSingleFieldToFirestore;

            const updateListField = useCallback((listName, itemId, field, value) => {
                const projectToUpdate = projects.find(p => p.id === currentProjectId);
                if (!projectToUpdate) return;
                const updatedList = projectToUpdate[listName].map(item => 
                    item.id === itemId ? { ...item, [field]: value } : item
                );
                updateToFirestore(currentProjectId, { [listName]: updatedList });
            }, [currentProjectId, projects, updateToFirestore]);

            const addListItem = useCallback((listName, newItem) => {
                const projectToUpdate = projects.find(p => p.id === currentProjectId);
                if (!projectToUpdate) return;
                const updatedList = [...projectToUpdate[listName], { ...newItem, id: generateId() }];
                updateToFirestore(currentProjectId, { [listName]: updatedList });
            }, [currentProjectId, projects, updateToFirestore]);

            const removeListItem = useCallback((listName, itemId) => {
                const projectToUpdate = projects.find(p => p.id === currentProjectId);
                if (!projectToUpdate) return;
                const updatedList = projectToUpdate[listName].filter(i => i.id !== itemId);
                updateToFirestore(currentProjectId, { [listName]: updatedList });
            }, [currentProjectId, projects, updateToFirestore]);

            // 計算邏輯
            const { 
                projectName, contractQty, unitPrice, paymentRequests, deductions, 
                deliveries, unusedInventory, projectedArea, wallArea, 
                subPayments, glueBuckets, tapeWideRolls, tapeNarrowRolls, shippingCost,
                lastUpdated, lastUpdatedBy 
            } = currentProject;

            const GLUE_PRICE = 1680;
            const TAPE_WIDE_PRICE = 24.5;
            const TAPE_NARROW_PRICE = 38;
            const ROLL_AREA = 50; 
            const MAT_COST_PER_SQM = 150; 

            const totalPaymentQty = paymentRequests.reduce((acc, curr) => acc + parseNum(curr.value), 0);
            const totalPaymentAmount = totalPaymentQty * parseNum(unitPrice); 
            const remainingContractQty = parseNum(contractQty) - totalPaymentQty;
            const totalDeductionAmount = deductions.reduce((acc, curr) => acc + parseNum(curr.value), 0);
            const totalDelivered = deliveries.reduce((acc, curr) => acc + parseNum(curr.value), 0);
            const totalUsedInventory = totalDelivered - parseNum(unusedInventory);
            const totalArea = totalUsedInventory * ROLL_AREA;
            const wasteAreaDisplay = Math.max(0, (parseNum(projectedArea) + parseNum(wallArea)) > 0 ? totalArea - (parseNum(projectedArea) + parseNum(wallArea)) : 0);
            const calculatedWasteRate = totalArea > 0 ? ((parseNum(wallArea) + wasteAreaDisplay) / totalArea) * 100 : 0;
            const totalSubPayment = subPayments.reduce((acc, curr) => acc + parseNum(curr.value), 0);
            const totalMaterialMiscCost = (parseNum(glueBuckets) * GLUE_PRICE) + (parseNum(tapeWideRolls) * TAPE_WIDE_PRICE) + (parseNum(tapeNarrowRolls) * TAPE_NARROW_PRICE);
            const matTotalCost = totalArea * MAT_COST_PER_SQM; 
            const totalCost = totalSubPayment + totalMaterialMiscCost + totalDeductionAmount + matTotalCost + parseNum(shippingCost);
            const grossProfit = totalPaymentAmount - totalCost; 
            const grossMargin = totalPaymentAmount > 0 ? (grossProfit / totalPaymentAmount) * 100 : 0;

            // --- 判斷渲染狀態 ---
            if (loadingAuth) {
                return <div className="min-h-screen flex items-center justify-center text-slate-500">載入中...</div>;
            }

            if (!user) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            return (
                <div className="max-w-4xl mx-auto pb-20 p-4 sm:p-6">
                    <header className="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-purple-100 p-2 rounded-full"><Users className="text-purple-600"/></div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800">隔音墊施工計算</h1>
                                <p className="text-xs text-slate-500 mt-1">
                                    團隊協作模式 • {user.displayName || user.email}
                                </p>
                            </div>
                        </div>
                        <button onClick={handleLogout} className="text-sm flex items-center gap-1 text-slate-500 hover:text-slate-800 border px-3 py-1.5 rounded-full hover:bg-white transition-all">
                            <LogOut size={16} /> 登出
                        </button>
                    </header>
                    
                    {/* 專案選擇區 */}
                    <div className="flex flex-col md:flex-row gap-3 items-start md:items-center bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-6">
                        <div className="flex items-center gap-2 w-full md:w-auto">
                            <FolderOpen className="text-purple-600" />
                            <label className="text-sm font-semibold text-slate-700">切換專案:</label>
                        </div>
                        <select 
                            className="flex-grow p-2 border border-slate-300 rounded-md shadow-sm w-full md:w-auto"
                            value={currentProjectId || ''}
                            onChange={(e) => setCurrentProjectId(e.target.value)}
                        >
                            {projects.length === 0 && <option value="" disabled>無專案</option>}
                            {projects.map(p => (
                                <option key={p.id} value={p.id}>
                                    {p.projectName} {p.lastUpdatedBy ? `(${p.lastUpdatedBy})` : ''} - {new Date(p.lastUpdated).toLocaleDateString()}
                                </option>
                            ))}
                        </select>
                        <div className="flex gap-2 mt-2 md:mt-0 w-full md:w-auto justify-end">
                            <button onClick={() => handleCreateProject()} className="flex items-center gap-1 text-sm bg-purple-500 text-white px-3 py-2 rounded hover:bg-purple-600 shadow-sm"><Plus size={16}/> 新增</button>
                            <button onClick={() => handleDeleteProject(currentProjectId)} className="flex items-center gap-1 text-sm bg-white border border-red-200 text-red-500 px-3 py-2 rounded hover:bg-red-50" disabled={!currentProjectId}><Trash2 size={16}/> 刪除</button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow p-6 mb-6 border border-slate-200 relative">
                        {/* 顯示最後更新者 */}
                        <div className="absolute top-4 right-4 text-xs text-slate-400">
                           最後編輯: {lastUpdatedBy || '未知'} ({new Date(lastUpdated).toLocaleString()})
                        </div>

                        <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">專案名稱</label>
                        <input 
                            type="text" 
                            value={tempProjectName} 
                            onChange={(e) => setTempProjectName(e.target.value)} 
                            className="block w-full rounded border-0 border-b-2 border-slate-200 p-0 py-2 text-xl font-bold focus:ring-0 focus:border-blue-500 transition-colors" 
                            placeholder="輸入專案名稱..." 
                        />
                    </div>

                    <div className="space-y-6">
                        {/* 1. 合約與請款 */}
                        <Card title="第一大項：合約與請款" icon={DollarSign}>
                            <div className="grid md:grid-cols-2 gap-6">
                                <div>
                                    <SectionHeader title="合約基礎資訊" />
                                    <SimpleInput label="合約數量" value={contractQty} onChange={(v) => updateProjectField('contractQty', v)} suffix="坪/m²" />
                                    <SimpleInput label="本案單價" value={unitPrice} onChange={(v) => updateProjectField('unitPrice', v)} suffix="元" />
                                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                                        <div className="text-sm text-blue-800 font-semibold mb-1">目前總營收</div>
                                        <div className="text-2xl font-bold text-blue-600">{formatCurrency(totalPaymentAmount)}</div>
                                        <div className="text-xs text-blue-400 mt-1">數量總計: {formatNumber(totalPaymentQty)}</div>
                                        <div className={`text-xs mt-1 font-bold ${remainingContractQty < 0 ? 'text-red-500' : 'text-green-600'}`}>
                                            合約剩餘: {formatNumber(remainingContractQty)}
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <SectionHeader title="請款進度" />
                                    {!parseNum(unitPrice) && (<div className="text-xs text-red-500 mb-2">* 請輸入單價以計算金額</div>)}
                                    <DynamicList 
                                        items={paymentRequests} 
                                        onAdd={() => addListItem('paymentRequests', { value: '' })}
                                        onRemove={(id) => removeListItem('paymentRequests', id)}
                                        onUpdate={(id, f, v) => updateListField('paymentRequests', id, f, v)}
                                        valueField="value"
                                        labelPrefix="請款" unitPrice={unitPrice} showPriceCalc 
                                    />
                                </div>
                            </div>
                            <div className="mt-6 border-t pt-4">
                                <SectionHeader title="扣款項目" />
                                {deductions.map(item => (
                                    <DeductionItem 
                                        key={item.id} item={item} 
                                        updateRow={(id, f, v) => updateListField('deductions', id, f, v)}
                                        onRemove={(id) => removeListItem('deductions', id)}
                                    />
                                ))}
                                <button onClick={() => addListItem('deductions', { name: '', value: '' })} className="flex items-center gap-1 text-sm text-blue-600 mt-2"><Plus size={16}/> 新增扣款</button>
                                <div className="text-right text-sm text-red-600 font-bold mt-2">扣款總計: -{formatCurrency(totalDeductionAmount)}</div>
                            </div>
                        </Card>

                        {/* 2. 進貨 */}
                        <Card title="第二大項：進貨與庫存" icon={Package}>
                            <div className="grid md:grid-cols-2 gap-6">
                                <div>
                                    <SectionHeader title="進貨紀錄 (卷)" />
                                    <DynamicList 
                                        items={deliveries} 
                                        onAdd={() => addListItem('deliveries', { date: '', value: '' })}
                                        onRemove={(id) => removeListItem('deliveries', id)}
                                        onUpdate={(id, f, v) => updateListField('deliveries', id, f, v)}
                                        valueField="value"
                                        labelPrefix="進貨" dateField="date" 
                                    />
                                    <div className="text-sm font-bold text-slate-700 bg-slate-100 p-2 rounded">累積進貨: {formatNumber(totalDelivered)}</div>
                                </div>
                                <div>
                                    <SectionHeader title="現場盤點" />
                                    <SimpleInput label="未使用數量 (卷)" value={unusedInventory} onChange={(v) => updateProjectField('unusedInventory', v)} />
                                    <div className="bg-orange-50 p-4 rounded-lg mt-4"><div className="text-sm text-orange-800 font-semibold mb-1">實際使用量</div><div className="text-2xl font-bold text-orange-600">{formatNumber(totalUsedInventory)}</div></div>
                                </div>
                            </div>
                        </Card>

                        {/* 3. 損耗 */}
                        <Card title="第三大項：損耗計算" icon={Activity}>
                            <div className="grid md:grid-cols-4 gap-4">
                                <SimpleInput label="投影面積" value={projectedArea} onChange={(v) => updateProjectField('projectedArea', v)} />
                                <SimpleInput label="上牆面積" value={wallArea} onChange={(v) => updateProjectField('wallArea', v)} />
                                <div className="mb-4"><label className="block text-sm font-medium text-slate-700 mb-1">總面積 (供料)</label><div className="bg-slate-100 border p-2 rounded text-lg font-bold text-blue-700">{formatNumber(totalArea)}</div></div>
                                <div className="mb-4"><label className="block text-sm font-medium text-slate-700 mb-1">損耗面積</label><div className="bg-slate-100 border p-2 rounded text-lg font-bold text-orange-700">{formatNumber(wasteAreaDisplay)}</div></div>
                            </div>
                            <div className="mt-4 p-4 bg-slate-800 text-white rounded-lg flex justify-between items-center"><span className="font-semibold">總損耗率：</span><span className="text-2xl font-mono text-yellow-400">{calculatedWasteRate.toFixed(2)}%</span></div>
                        </Card>

                        {/* 4. 成本 */}
                        <Card title="第四大項：成本分析" icon={Calculator}>
                            <div className="grid md:grid-cols-2 gap-8">
                                <div>
                                    <SectionHeader title="小恩施作費用" />
                                    <DynamicList 
                                        items={subPayments} 
                                        onAdd={() => addListItem('subPayments', { value: '' })}
                                        onRemove={(id) => removeListItem('subPayments', id)}
                                        onUpdate={(id, f, v) => updateListField('subPayments', id, f, v)}
                                        valueField="value"
                                        labelPrefix="請款" 
                                    />
                                    <div className="text-right font-bold mt-2">施工費總計: {formatCurrency(totalSubPayment)}</div>
                                </div>
                                <div>
                                    <SectionHeader title="材料成本" />
                                    <div className="flex gap-4 items-center mb-2"><div className="flex-1 text-sm">膠水 ({formatCurrency(GLUE_PRICE)})</div><div className="w-24"><SimpleInput value={glueBuckets} onChange={(v) => updateProjectField('glueBuckets', v)} placeholder="數量" /></div></div>
                                    <div className="flex gap-4 items-center mb-2"><div className="flex-1 text-sm">寬版膠帶 ({formatCurrency(TAPE_WIDE_PRICE)})</div><div className="w-24"><SimpleInput value={tapeWideRolls} onChange={(v) => updateProjectField('tapeWideRolls', v)} placeholder="數量" /></div></div>
                                    <div className="flex gap-4 items-center mb-2"><div className="flex-1 text-sm">窄版膠帶 ({formatCurrency(TAPE_NARROW_PRICE)})</div><div className="w-24"><SimpleInput value={tapeNarrowRolls} onChange={(v) => updateProjectField('tapeNarrowRolls', v)} placeholder="數量" /></div></div>
                                    
                                    <div className="border-t pt-2 mt-2"><SimpleInput label="運費/雜項" value={shippingCost} onChange={(v) => updateProjectField('shippingCost', v)} suffix="元" /></div>
                                    
                                    <div className="text-right text-sm font-bold mt-2">耗材總計: {formatCurrency(totalMaterialMiscCost)}</div>
                                    
                                    <div className="text-right text-sm font-bold text-blue-700 mt-2">隔音墊成本: {formatCurrency(matTotalCost)}</div>
                                    <div className="text-xs text-gray-500 text-right">
                                        = {formatNumber(totalUsedInventory)} 卷 &times; {ROLL_AREA} M²/卷 &times; {formatCurrency(MAT_COST_PER_SQM)}/M²
                                    </div>
                                </div>
                            </div>
                        </Card>

                        {/* 5. 毛利 */}
                        <Card title="第五大項：毛利分析" icon={TrendingUp}>
                            <div className="space-y-3 text-lg">
                                {/* Revenue */}
                                <div className="flex justify-between font-semibold">
                                    <span>總營收 (請款)</span>
                                    <span>{formatCurrency(totalPaymentAmount)}</span>
                                </div>

                                <div className="border-t border-slate-200 my-2"></div>

                                {/* Cost Breakdown Section */}
                                <div className="text-sm text-slate-600 space-y-1">
                                    <div className="font-semibold text-slate-800 mb-2">成本結構：</div>
                                    <div className="flex justify-between"><span>(-) 扣款合計</span><span>{formatCurrency(totalDeductionAmount)}</span></div>
                                    <div className="flex justify-between"><span>(-) 小恩施作費用</span><span>{formatCurrency(totalSubPayment)}</span></div>
                                    <div className="flex justify-between"><span>(-) 其他耗材</span><span>{formatCurrency(totalMaterialMiscCost)}</span></div>
                                    <div className="flex justify-between"><span>(-) 運費/雜項</span><span>{formatCurrency(parseNum(shippingCost))}</span></div>
                                    <div className="flex justify-between"><span>(-) 隔音墊成本</span><span>{formatCurrency(matTotalCost)}</span></div>
                                </div>

                                {/* Total Cost Summary */}
                                <div className="flex justify-between text-red-500 font-semibold border-t border-dashed border-slate-300 pt-2">
                                    <span>總成本合計</span>
                                    <span>-{formatCurrency(totalCost)}</span>
                                </div>

                                <div className="border-t border-slate-400 my-3"></div>

                                {/* Profit and Margin */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-green-50 p-4 rounded-lg text-center">
                                        <div className="text-sm text-green-700 mb-1">毛利金額</div>
                                        <div className={`text-2xl font-bold ${grossProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(grossProfit)}
                                        </div>
                                    </div>
                                    <div className="bg-purple-50 p-4 rounded-lg text-center">
                                        <div className="text-sm text-purple-700 mb-1">毛利率</div>
                                        <div className={`text-2xl font-bold ${grossMargin >= 0 ? 'text-purple-600' : 'text-red-600'}`}>
                                            {grossMargin.toFixed(2)}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        }
    </script>
</body>
</html>
